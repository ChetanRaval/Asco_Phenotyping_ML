---
title: "Assessment of *Ascochyta rabiei* Disease Symptoms Using Machine Learning Image Analysis"
author: "Chetan Reval and Ido Bar"
date: "09 June 2022"
output: 
    bookdown::html_document2:
      df_print: paged
      theme: united
      # see other themes in https://www.datadreaming.org/post/r-markdown-theme-gallery/
      highlight: tango
      #    highlight: pygments (see other syntax highlighting styles in https://www.garrickadenbuie.com/blog/pandoc-syntax-highlighting-examples/)
      css: "style/style.css" # custom css styling
      toc: true
      toc_float: true
      toc_depth: 3
      number_sections: false
      code_folding: hide
      fig_caption: true
      always_allow_html: true
#      keep_md: true
bibliography: style/phenotyping_ML.bib # this contains the references used in this document (exported from Zotero in bibtex format)
csl: style/springer-basic-improved-author-date-with-italic-et-al-period.csl # this contains the citation style, you can bring any style from https://github.com/citation-style-language/styles
---

```{r setup, include=FALSE}
# setting up the environment, including packages required (anything here won't be visible in the document)
devtools::source_gist("7f63547158ecdbacf31b54a58af0d1cc", filename = "util.R")
knitr::opts_chunk$set(list(echo = TRUE, eval=TRUE, message=FALSE, warning=FALSE))
# options(width = 180)
# CRAN settings
chooseCRANmirror(ind=1)
options(repos = getOption("repos")["CRAN"]) # fix the annoying "unable to access index..."
# packages required for the markdown loaded here, others will be loaded later in the Image Processing section in the Methods
pacman::p_load(tidyverse, readxl, scales, paletteer, 
               htmltools, ggrepel, here,  DT, captioner, plotly,
               tabulizer)
# Custom Font Format (for package names, etc.)
custom_font="consolas"
fontFmt = function(x,font="consolas"){
  #outputFormat = knitr::opts_knit$get("rmarkdown.pandoc.to")
  #if (outputFormat == 'html')
  formatted_text <- sprintf("<font face='%s'>%s</font>",font,x)
  return(formatted_text)
  #else
  #  x
}
```

## Introduction

*Ascochyta rabiei* is a necrotrophic fungus, causing the Ascochyta blight disease on chickpea, a disease that can cause substantial damage to crops and reduce yield and profits. The disease poses a major risk to the chickpea industry in Australia and worldwide and therefore significant efforts are invested to better understand and monitor the population of *A. rabiei* and identify the most aggressive isolates that are then used to screen breeding material to develop more resistant (or less susceptible) varieties.

The aggressiveness level of *A. rabiei* is determined by assessing the disease symptoms on a differential set of host chickpea varieties/genotypes, in a process that is termed "phenotyping". The Plant Pathology team at the Sustainable Food Production group at Griffith University (led by [Prof Rebecca Ford](https://experts.griffith.edu.au/18969-rebecca-ford) and [Dr Ido Bar](https://experts.griffith.edu.au/8327-ido-bar)) are preforming those assessments annually on a collection of *A. rabiei* isolates collected from the chickpea growing regions in Australia each year. The assessment is performed on 5 weeks old chickpea seedlings that have been inoculated with *A. rabiei* isolates and grown in controlled environment conditions that are conducive for the fungus to establish itself and cause disease on the plants. The exact phenotyping methods are described in [@sambasivamEvidenceRecentIncreased2020; @mehmoodEvidenceConsequenceHighly2017]

### Aims

-   Review machine-learning methods and approaches that can be applied to automatically assess disease symptoms from captured imaged
-   Apply and optimise selected methods and assess their accuracy, efficiency and correlation with traditional plant pathology visual assessment method

## Methods

### Experimental Design

Disease assessment bioassays were managed and performed by a trained plant pathologist (Melody Christie). Each bioassay included 6 *A. rabiei* isolates which were used to inoculate 5 differential chickpea host genotypes. The assays were performed in a blinded replicated design, where each isolate-host combination was replicated in 2 pots, each containing 5 chickpea seedlings. The seedlings were inoculated at 3 weeks after germination and were assessed 2 weeks post inoculation. 

The assessment was then performed for each plant in each pot and the leaf and stem disease scores were assessed (on a qualitative ordinal 1-9 scale), as well as the percentage of the diseased area [@sambasivamEvidenceRecentIncreased2020; @mehmoodEvidenceConsequenceHighly2017]. The disease assessment scores were recorded on a tablet using an online form. An example of a pot with chickpea seedlings infected with Ascochyta blight prior to assessment can be seen in Figure \@ref(fig:diseased-plant) below.

```{r diseased-plant, fig.cap="Chickpea seedlings affected by *Ascochyta rabiei*", out.width="100%"}
knitr::include_graphics("input_images/infected_plant_in pot.jpg")

```

### Image Capture

An imaging light box ([Neewer Upgraded Photo Light Box, 40x40x40 cm](https://www.amazon.com.au/gp/product/B0921MD235)) with a camera tripod ([Neewer Camera Tripod Monopod with Rotatable Center Column](https://www.amazon.com.au/gp/product/B0734ZZN61)) and a Sony digital camera (**add model here**) that was mounted and operated remotely using XXXX software, were used to capture images of the diseased plants (see setup in Figure \@ref(fig:image-capture-setup)). Each plant was laid flat in the imaging box and captured by at least 2 images to represent both sides prior to the visual pathology assessment.  

```{r image-capture-setup, fig.cap="Image capture setup for disease assessment of *Ascochyta rabiei*", out.width="100%"}
knitr::include_graphics("input_images/image_capture_setup.jpg")

```

### Image Processing for Disease Assessment

Image analysis and data processing and visualisation were performed in the `r R.version.string` statistical computing environment [@R_2017; @ihakaLanguageDataAnalysis1996]. Specifically, various packages from the [`r fontFmt("tidyverse")`](https://www.tidyverse.org/) collection were used for general data import, wrangling, summary and visualisation and [`r fontFmt("janitor")`](http://sfirke.github.io/janitor/) was used for data cleansing and sanitising [@tidyverse2019; @janitor2021].
The [`r fontFmt("magick")`](https://docs.ropensci.org/magick/) and [`r fontFmt("pliman")`](https://tiagoolivoto.github.io/pliman/index.html) R packages were used for image analysis and automatic disease assessment [@olivotoLightsCameraPliman2022; @magickR2021]. The [`r fontFmt("furrr")`](https://furrr.futureverse.org/) package was used to process the images in parallel along with [`r fontFmt("tictoc")`](https://collectivemedia.github.io/tictoc/) to measure and evaluate processing times [@tictoc2021; @furrr2022]. 

```{r load-packages}
# install/load packages in one-liner
library(pacman)
# load/install from GitHub repos
p_load_gh(char = c("TiagoOlivoto/pliman", 
                   "DavisVaughan/furrr", 
                   "HenrikBengtsson/progressr"))
# load/install from CRAN/BioConductor
p_load(tidyverse, magick, tictoc, Microsoft365R, janitor, ISOweek)

```

#### Overview:

1.  Cropping
2.  Background removal
3.  Disease assessment using `r fontFmt("pliman")`
4.  Return results as a table with the image-based assessment for each plant in each pot  

Show an example of the image processing, i.e. cropping and removal of background (but use `fill="blue"` to highlight the background removal)

### Evaluation of Image-based Assessments

The visual pathology assessment data was downloaded directly from the SharePoint site capturing the online form submissions using `r fontFmt("Microsoft365R")` R package [@Microsoft365R2021]. The data was merged with the bioassay design spreadsheet to assign an isolate-host combination for each pot.  

## Results

The images from each phenotyping bioassay were processed as detailed above and summarised in

```{r pliman-results}

```

## Conclusion

## General information

This document was last updated at `r Sys.time()` using R Markdown (built with `r R.version.string`). Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. It is especially powerful at authoring dynamic documents and reports which can showcase and execute code chunks and use the results in the output. For more details on using R Markdown see <http://rmarkdown.rstudio.com> and [Rmarkdown cheatsheet](https://www.rstudio.com/wp-content/uploads/2016/03/rmarkdown-cheatsheet-2.0.pdf).

------------------------------------------------------------------------

## Bibliography

<!-- ```{r results='asis', eval=TRUE} -->

<!-- PrintBibliography(biblio) -->

<!-- ``` -->
